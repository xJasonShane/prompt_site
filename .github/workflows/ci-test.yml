# CI Test Workflow
# ç”¨äºåœ¨éä¸»åˆ†æ”¯æ¨é€æ—¶æ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥å’Œæ„å»ºæµ‹è¯•
name: CI Test

on:
  push:
    branches-ignore:
      - main
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - '.gitignore'

jobs:
  ci-test:
    name: CI Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      contents: read
      actions: read
    
    steps:
      - name: Checkout code
        id: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        id: setup-node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      - name: Install dependencies
        id: install-deps
        run: |
          echo "Installing dependencies..."
          npm ci --legacy-peer-deps
          echo "Dependencies installed successfully!"
      
      - name: Run lint check
        id: lint
        run: |
          echo "Running lint check..."
          npm run lint -- --output-file=lint-results.json --format=json
          echo "Lint check completed!"
        continue-on-error: true
      
      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: lint-results.json
      
      - name: Run type check
        id: typecheck
        run: |
          echo "Running type check..."
          npx tsc --noEmit --pretty
          echo "Type check completed successfully!"
      
      - name: Build project
        id: build
        run: |
          echo "Building project..."
          npm run build
          echo "Build completed successfully!"
      
      - name: Check for test scripts
        id: check-tests
        run: |
          if grep -q "test" package.json; then
            echo "has-tests=true" >> $GITHUB_OUTPUT
          else
            echo "has-tests=false" >> $GITHUB_OUTPUT
            echo "No test script found in package.json"
          fi
      
      - name: Run tests
        id: run-tests
        if: steps.check-tests.outputs.has-tests == 'true'
        run: |
          echo "Running tests..."
          npm test -- --verbose
          echo "Tests completed successfully!"
      
      - name: Summary
        id: summary
        if: always()
        run: |
          echo "## CI Test Summary"
          echo "âœ… Checkout: ${{ steps.checkout.outcome }}"
          echo "âœ… Setup Node.js: ${{ steps.setup-node.outcome }}"
          echo "âœ… Install Dependencies: ${{ steps.install-deps.outcome }}"
          echo "âœ… Lint Check: ${{ steps.lint.outcome }}"
          echo "âœ… Type Check: ${{ steps.typecheck.outcome }}"
          echo "âœ… Build: ${{ steps.build.outcome }}"
          echo "âœ… Tests: ${{ steps.run-tests.outcome || 'Skipped' }}"
          
          # å¦‚æœæœ‰å¤±è´¥çš„æ­¥éª¤ï¼Œè¾“å‡ºè¯¦ç»†ä¿¡æ¯
          if [[ "${{ steps.lint.outcome }}" == "failure" ]]; then
            echo "\nâŒ Lint check failed. Please review the lint results artifact."
            exit 1
          fi
          
          if [[ "${{ steps.typecheck.outcome }}" == "failure" ]]; then
            echo "\nâŒ Type check failed. Please review the type errors above."
            exit 1
          fi
          
          if [[ "${{ steps.build.outcome }}" == "failure" ]]; then
            echo "\nâŒ Build failed. Please review the build errors above."
            exit 1
          fi
          
          if [[ "${{ steps.run-tests.outcome }}" == "failure" ]]; then
            echo "\nâŒ Tests failed. Please review the test results above."
            exit 1
          fi
          
          echo "\nğŸ‰ All CI tests passed successfully!"
